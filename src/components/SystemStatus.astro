---
---

<div class="system-status-widget" id="systemStatusWidget">
  <div class="status-indicator" id="statusIndicator">
    <div class="status-icon" id="statusIcon">
      <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
        <circle cx="6" cy="6" r="5" fill="currentColor"/>
      </svg>
    </div>
    <span id="statusText">Verificare...</span>
  </div>
  
  <button type="button" class="status-details-toggle" id="statusDetailsToggle" aria-expanded="false">
    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
      <path d="M8 9.5C8.82843 9.5 9.5 8.82843 9.5 8C9.5 7.17157 8.82843 6.5 8 6.5C7.17157 6.5 6.5 7.17157 6.5 8C6.5 8.82843 7.17157 9.5 8 9.5Z" fill="currentColor"/>
      <path d="M8 4C8.55228 4 9 3.55228 9 3C9 2.44772 8.55228 2 8 2C7.44772 2 7 2.44772 7 3C7 3.55228 7.44772 4 8 4Z" fill="currentColor"/>
      <path d="M8 14C8.55228 14 9 13.5523 9 13C9 12.4477 8.55228 12 8 12C7.44772 12 7 12.4477 7 13C7 13.5523 7.44772 14 8 14Z" fill="currentColor"/>
    </svg>
  </button>
</div>

<div class="status-details-panel" id="statusDetailsPanel" hidden>
  <div class="status-details-content">
    <div id="statusDetailsContent">
      <div class="status-loading">Se încarcă...</div>
    </div>
    <button type="button" class="status-close-btn" id="statusCloseBtn">Închide</button>
  </div>
</div>

<style>
  .system-status-widget {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
    padding: 0.625rem 0.875rem;
    background: var(--ui-bg-secondary);
    border: 1px solid var(--ui-border);
    border-radius: 8px;
    margin-bottom: 1.5rem;
  }

  .status-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.8125rem;
    font-weight: 500;
  }

  .status-icon {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .status-icon.healthy {
    color: var(--ui-success);
  }

  .status-icon.degraded {
    color: #f59e0b;
    animation: pulse 2s ease-in-out infinite;
  }

  .status-icon.unhealthy {
    color: var(--ui-error);
    animation: pulse 1.5s ease-in-out infinite;
  }

  .status-icon.checking {
    color: var(--ui-muted);
    animation: pulse 2s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  .status-details-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.25rem;
    background: transparent;
    border: none;
    color: var(--ui-muted);
    cursor: pointer;
    transition: all 0.2s;
    border-radius: 4px;
  }

  .status-details-toggle:hover {
    background: var(--ui-bg-hover);
    color: var(--ui-text);
  }

  .status-details-panel {
    margin-bottom: 1.5rem;
    border: 1px solid var(--ui-border);
    border-radius: 8px;
    background: var(--ui-bg-secondary);
    overflow: hidden;
  }

  .status-details-content {
    padding: 1.25rem;
  }

  .status-loading {
    padding: 1.5rem;
    text-align: center;
    color: var(--ui-muted);
    font-size: 0.875rem;
  }

  .status-summary {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .status-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.625rem;
    background: var(--ui-bg);
    border-radius: 6px;
    font-size: 0.875rem;
  }

  .status-row-label {
    color: var(--ui-muted);
    font-weight: 500;
  }

  .status-row-value {
    font-weight: 600;
  }

  .status-row-value.ok {
    color: var(--ui-success);
  }

  .status-row-value.warning {
    color: #f59e0b;
  }

  .status-row-value.error {
    color: var(--ui-error);
  }

  .status-issues {
    margin-top: 0.75rem;
    padding: 0.75rem;
    background: color-mix(in srgb, var(--ui-error) 5%, transparent);
    border-left: 3px solid var(--ui-error);
    border-radius: 4px;
  }

  .status-issues-title {
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--ui-error);
    margin-bottom: 0.5rem;
  }

  .status-issues-list {
    list-style: none;
    padding: 0;
    margin: 0;
    font-size: 0.8125rem;
    color: var(--ui-text);
  }

  .status-issues-list li {
    padding: 0.25rem 0;
  }

  .status-issues-list li::before {
    content: "• ";
    color: var(--ui-error);
    font-weight: bold;
    margin-right: 0.375rem;
  }

  .status-close-btn {
    width: 100%;
    margin-top: 1rem;
    padding: 0.625rem;
    background: transparent;
    border: 1px solid var(--ui-border);
    border-radius: 6px;
    color: var(--ui-text);
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
  }

  .status-close-btn:hover {
    background: var(--ui-bg-hover);
  }

  .status-timestamp {
    font-size: 0.75rem;
    color: var(--ui-muted);
    margin-top: 0.75rem;
    text-align: center;
  }
</style>

<script>
  const STATUS_API_URL = 'https://ref-tool-worker.florianvictorcristea.workers.dev/api/status';
  
  let lastStatusData: any = null;

  interface SystemStatus {
    status: 'healthy' | 'degraded' | 'unhealthy';
    timestamp: string;
    templates: Array<{
      path: string;
      exists: boolean;
      hashValid?: boolean;
      error?: string;
    }>;
    font: {
      exists: boolean;
      hashValid?: boolean;
      error?: string;
    };
    autotest?: {
      passed: boolean;
      errors?: string[];
      duration?: number;
    };
    issues?: string[];
  }

  async function checkSystemStatus(forceRefresh = false): Promise<void> {
    const statusIcon = document.getElementById('statusIcon');
    const statusText = document.getElementById('statusText');
    
    if (!statusIcon || !statusText) return;

    try {
      const url = forceRefresh ? `${STATUS_API_URL}?refresh=true` : STATUS_API_URL;
      const response = await fetch(url);
      const data: SystemStatus = await response.json();
      
      lastStatusData = data;
      
      // Update indicator
      statusIcon.className = `status-icon ${data.status}`;
      
      const statusMessages = {
        healthy: 'Sistem operațional',
        degraded: 'Funcționare limitată',
        unhealthy: 'Probleme detectate'
      };
      
      statusText.textContent = statusMessages[data.status] || 'Status necunoscut';
      
      // Update details if panel is open
      const panel = document.getElementById('statusDetailsPanel');
      if (panel && !panel.hasAttribute('hidden')) {
        updateStatusDetails(data);
      }
      
    } catch (error) {
      console.error('Failed to check system status:', error);
      if (statusIcon && statusText) {
        statusIcon.className = 'status-icon unhealthy';
        statusText.textContent = 'Eroare verificare';
      }
    }
  }

  function updateStatusDetails(data: SystemStatus): void {
    const container = document.getElementById('statusDetailsContent');
    if (!container) return;

    const templatesOk = data.templates.filter(t => t.exists && t.hashValid !== false).length;
    const templatesTotal = data.templates.length;
    const fontOk = data.font.exists && data.font.hashValid !== false;
    const autotestPassed = data.autotest?.passed ?? false;

    let summaryHtml = `
      <div class="status-summary">
        <div class="status-row">
          <span class="status-row-label">Șabloane PDF</span>
          <span class="status-row-value ${templatesOk === templatesTotal ? 'ok' : 'error'}">
            ${templatesOk}/${templatesTotal}
          </span>
        </div>
        <div class="status-row">
          <span class="status-row-label">Font</span>
          <span class="status-row-value ${fontOk ? 'ok' : 'error'}">
            ${fontOk ? 'OK' : 'Eroare'}
          </span>
        </div>
        ${data.autotest ? `
        <div class="status-row">
          <span class="status-row-label">Test automat</span>
          <span class="status-row-value ${autotestPassed ? 'ok' : 'error'}">
            ${autotestPassed ? 'Succes' : 'Eșuat'} (${data.autotest.duration}ms)
          </span>
        </div>
        ` : ''}
      </div>
    `;

    if (data.issues && data.issues.length > 0) {
      summaryHtml += `
        <div class="status-issues">
          <div class="status-issues-title">Probleme detectate:</div>
          <ul class="status-issues-list">
            ${data.issues.map(issue => `<li>${issue}</li>`).join('')}
          </ul>
        </div>
      `;
    }

    summaryHtml += `<div class="status-timestamp">Ultima verificare: ${new Date(data.timestamp).toLocaleString('ro-RO', { 
      day: '2-digit', 
      month: '2-digit', 
      year: 'numeric',
      hour: '2-digit', 
      minute: '2-digit' 
    })}</div>`;

    container.innerHTML = summaryHtml;
  }

  function setupStatusWidget(): void {
    const toggleBtn = document.getElementById('statusDetailsToggle');
    const panel = document.getElementById('statusDetailsPanel');
    const closeBtn = document.getElementById('statusCloseBtn');

    toggleBtn?.addEventListener('click', () => {
      const isExpanded = toggleBtn.getAttribute('aria-expanded') === 'true';
      
      if (isExpanded) {
        toggleBtn.setAttribute('aria-expanded', 'false');
        panel?.setAttribute('hidden', '');
      } else {
        toggleBtn.setAttribute('aria-expanded', 'true');
        panel?.removeAttribute('hidden');
        if (lastStatusData) {
          updateStatusDetails(lastStatusData);
        } else {
          checkSystemStatus();
        }
      }
    });

    closeBtn?.addEventListener('click', () => {
      toggleBtn?.setAttribute('aria-expanded', 'false');
      panel?.setAttribute('hidden', '');
    });
  }

  // Initialize
  if (typeof window !== 'undefined') {
    document.addEventListener('DOMContentLoaded', () => {
      setupStatusWidget();
      checkSystemStatus(); // Check once on load
    });
  }
</script>
