---
---

<div class="status-container">
  <div class="status-bar" id="systemStatusWidget">
    <div class="status-dot checking" id="statusDot"></div>
    <span class="status-text" id="statusText">Verificare sistem...</span>
    <button type="button" class="status-toggle" id="statusDetailsToggle" aria-label="Detalii status">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="1"></circle>
        <circle cx="19" cy="12" r="1"></circle>
        <circle cx="5" cy="12" r="1"></circle>
      </svg>
    </button>
  </div>
  
  <div class="status-details" id="statusDetailsPanel">
    <div id="statusDetailsContent">
      <div class="status-loading">Se încarcă...</div>
    </div>
    <button type="button" class="btn-secondary btn-small" id="statusCloseBtn" style="width: 100%; margin-top: 1rem;">Închide</button>
  </div>
</div>

<style>
  .status-container {
    margin-bottom: var(--spacing-lg);
  }

  .status-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-sm);
    padding: 0.75rem 1rem;
    background: rgba(56, 73, 89, 0.3);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    font-size: var(--font-size-sm);
  }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .status-dot.checking {
    background: var(--color-steel);
    animation: pulse 2s ease-in-out infinite;
  }

  .status-dot.healthy {
    background: var(--color-success);
    box-shadow: 0 0 10px var(--color-success);
    animation: pulse 2s ease-in-out infinite;
  }

  .status-dot.degraded {
    background: var(--color-warning);
    box-shadow: 0 0 10px var(--color-warning);
    animation: pulse 1.5s ease-in-out infinite;
  }

  .status-dot.unhealthy {
    background: var(--color-error);
    box-shadow: 0 0 10px var(--color-error);
    animation: pulse 1s ease-in-out infinite;
  }

  .status-text {
    color: var(--color-text-secondary);
    flex: 1;
    text-align: center;
  }

  .status-toggle {
    width: 28px;
    height: 28px;
    padding: 0;
    background: transparent;
    border: 1px solid var(--color-border);
    border-radius: 6px;
    color: var(--color-text-muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-fast);
    box-shadow: none;
  }

  .status-toggle:hover {
    background: rgba(106, 137, 167, 0.2);
    border-color: var(--color-border-hover);
    color: var(--color-text-primary);
    transform: none;
    box-shadow: none;
  }

  .status-details {
    display: none;
    margin-top: var(--spacing-sm);
    padding: var(--spacing-md);
    background: rgba(56, 73, 89, 0.2);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    animation: fadeIn 0.3s ease;
  }

  .status-details.active {
    display: block;
  }

  .status-loading {
    text-align: center;
    color: var(--color-text-muted);
    padding: var(--spacing-md);
  }

  .status-summary {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
  }

  .status-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.625rem 0.875rem;
    background: rgba(56, 73, 89, 0.3);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
  }

  .status-row-label {
    color: var(--color-text-muted);
    font-weight: 500;
  }

  .status-row-value {
    font-weight: 600;
  }

  .status-row-value.ok {
    color: var(--color-success);
  }

  .status-row-value.warning {
    color: var(--color-warning);
  }

  .status-row-value.error {
    color: var(--color-error);
  }

  .status-issues {
    margin-top: var(--spacing-sm);
    padding: var(--spacing-sm) var(--spacing-md);
    background: rgba(248, 113, 113, 0.1);
    border-left: 3px solid var(--color-error);
    border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
  }

  .status-issues-title {
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--color-error);
    margin-bottom: var(--spacing-xs);
  }

  .status-issues-list {
    list-style: none;
    padding: 0;
    margin: 0;
    font-size: var(--font-size-xs);
  }

  .status-issues-list li {
    padding: 0.25rem 0;
    color: var(--color-text-secondary);
  }

  .status-issues-list li::before {
    content: "• ";
    color: var(--color-error);
    font-weight: bold;
  }

  .status-timestamp {
    font-size: var(--font-size-xs);
    color: var(--color-text-muted);
    margin-top: var(--spacing-sm);
    text-align: center;
  }
</style>

<script>
  const STATUS_API_URL = 'https://ref-tool-worker.florianvictorcristea.workers.dev/api/status';
  
  let lastStatusData: any = null;

  interface SystemStatus {
    status: 'healthy' | 'degraded' | 'unhealthy';
    timestamp: string;
    templates: Array<{
      path: string;
      exists: boolean;
      hashValid?: boolean;
      error?: string;
    }>;
    font: {
      exists: boolean;
      hashValid?: boolean;
      error?: string;
    };
    autotest?: {
      passed: boolean;
      errors?: string[];
      duration?: number;
    };
    issues?: string[];
  }

  async function checkSystemStatus(): Promise<void> {
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    
    if (!statusDot || !statusText) return;

    try {
      const response = await fetch(STATUS_API_URL);
      const data: SystemStatus = await response.json();
      
      lastStatusData = data;
      
      // Update indicator
      statusDot.className = `status-dot ${data.status}`;
      
      const statusMessages = {
        healthy: 'Sistem operațional',
        degraded: 'Funcționare limitată',
        unhealthy: 'Probleme detectate'
      };
      
      statusText.textContent = statusMessages[data.status] || 'Status necunoscut';
      
      // Update details if panel is open
      const panel = document.getElementById('statusDetailsPanel');
      if (panel?.classList.contains('active')) {
        updateStatusDetails(data);
      }
      
    } catch (error) {
      console.error('Failed to check system status:', error);
      if (statusDot && statusText) {
        statusDot.className = 'status-dot unhealthy';
        statusText.textContent = 'Eroare verificare';
      }
    }
  }

  function updateStatusDetails(data: SystemStatus): void {
    const container = document.getElementById('statusDetailsContent');
    if (!container) return;

    const templatesOk = data.templates.filter(t => t.exists && t.hashValid !== false).length;
    const templatesTotal = data.templates.length;
    const fontOk = data.font.exists && data.font.hashValid !== false;
    const autotestPassed = data.autotest?.passed ?? false;

    let summaryHtml = `
      <div class="status-summary">
        <div class="status-row">
          <span class="status-row-label">Șabloane PDF:</span>
          <span class="status-row-value ${templatesOk === templatesTotal ? 'ok' : 'error'}">
            ${templatesOk}/${templatesTotal}
          </span>
        </div>
        <div class="status-row">
          <span class="status-row-label">Font:</span>
          <span class="status-row-value ${fontOk ? 'ok' : 'error'}">
            ${fontOk ? 'OK' : 'Eroare'}
          </span>
        </div>
        ${data.autotest ? `
        <div class="status-row">
          <span class="status-row-label">Test automat:</span>
          <span class="status-row-value ${autotestPassed ? 'ok' : 'error'}">
            ${autotestPassed ? 'Succes' : 'Eșuat'} (${data.autotest.duration}ms)
          </span>
        </div>
        ` : ''}
      </div>
    `;

    if (data.issues && data.issues.length > 0) {
      summaryHtml += `
        <div class="status-issues">
          <div class="status-issues-title">Probleme detectate:</div>
          <ul class="status-issues-list">
            ${data.issues.map(issue => `<li>${issue}</li>`).join('')}
          </ul>
        </div>
      `;
    }

    summaryHtml += `<div class="status-timestamp">Ultima verificare: ${new Date(data.timestamp).toLocaleString('ro-RO', { 
      day: '2-digit', 
      month: '2-digit', 
      year: 'numeric',
      hour: '2-digit', 
      minute: '2-digit' 
    })}</div>`;

    container.innerHTML = summaryHtml;
  }

  function setupStatusWidget(): void {
    const toggleBtn = document.getElementById('statusDetailsToggle');
    const panel = document.getElementById('statusDetailsPanel');
    const closeBtn = document.getElementById('statusCloseBtn');

    toggleBtn?.addEventListener('click', () => {
      const isActive = panel?.classList.contains('active');
      
      if (isActive) {
        panel?.classList.remove('active');
      } else {
        panel?.classList.add('active');
        if (lastStatusData) {
          updateStatusDetails(lastStatusData);
        }
      }
    });

    closeBtn?.addEventListener('click', () => {
      panel?.classList.remove('active');
    });
  }

  // Initialize
  if (typeof window !== 'undefined') {
    document.addEventListener('DOMContentLoaded', () => {
      setupStatusWidget();
      checkSystemStatus();
    });
  }
</script>
