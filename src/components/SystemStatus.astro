---
---

<div class="system-status-widget" id="systemStatusWidget">
  <div class="status-indicator" id="statusIndicator">
    <div class="status-icon" id="statusIcon">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
        <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="2"/>
      </svg>
    </div>
    <span id="statusText">Verificare sistem...</span>
  </div>
  
  <button type="button" class="status-details-toggle" id="statusDetailsToggle" aria-expanded="false">
    <span>Detalii</span>
    <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
      <path d="M3 5L6 8L9 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </button>
</div>

<div class="status-details-panel" id="statusDetailsPanel" hidden>
  <div class="status-details-content">
    <h3>Status Sistem</h3>
    <div id="statusDetailsContent">
      <div class="status-loading">Se încarcă...</div>
    </div>
    <div class="status-actions">
      <button type="button" class="status-refresh-btn" id="statusRefreshBtn">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
          <path d="M14 8C14 11.3137 11.3137 14 8 14C4.68629 14 2 11.3137 2 8C2 4.68629 4.68629 2 8 2C9.84799 2 11.4892 2.87733 12.5355 4.22183M12.5355 4.22183L14 2M12.5355 4.22183L10 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Reîmprospătează
      </button>
      <button type="button" class="status-close-btn" id="statusCloseBtn">Închide</button>
    </div>
  </div>
</div>

<style>
  .system-status-widget {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    padding: 0.75rem 1rem;
    background: var(--ui-bg-secondary);
    border: 1px solid var(--ui-border);
    border-radius: 8px;
    margin-bottom: 1.5rem;
  }

  .status-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
  }

  .status-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    animation: pulse 2s ease-in-out infinite;
  }

  .status-icon.healthy {
    color: var(--ui-success);
    animation: none;
  }

  .status-icon.degraded {
    color: #f59e0b;
    animation: pulse 2s ease-in-out infinite;
  }

  .status-icon.unhealthy {
    color: var(--ui-error);
    animation: pulse 1s ease-in-out infinite;
  }

  .status-icon.checking {
    color: var(--ui-muted);
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  .status-details-toggle {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: transparent;
    border: 1px solid var(--ui-border);
    border-radius: 6px;
    color: var(--ui-text);
    cursor: pointer;
    font-size: 0.875rem;
    transition: all 0.2s;
  }

  .status-details-toggle:hover {
    background: var(--ui-bg-hover);
  }

  .status-details-toggle svg {
    transition: transform 0.2s;
  }

  .status-details-toggle[aria-expanded="true"] svg {
    transform: rotate(180deg);
  }

  .status-details-panel {
    margin-bottom: 1.5rem;
    border: 1px solid var(--ui-border);
    border-radius: 8px;
    background: var(--ui-bg-secondary);
    overflow: hidden;
  }

  .status-details-content {
    padding: 1.5rem;
  }

  .status-details-content h3 {
    margin: 0 0 1rem 0;
    font-size: 1rem;
    font-weight: 600;
  }

  .status-loading {
    padding: 2rem;
    text-align: center;
    color: var(--ui-muted);
  }

  .status-grid {
    display: grid;
    gap: 1rem;
  }

  .status-item {
    padding: 1rem;
    background: var(--ui-bg);
    border: 1px solid var(--ui-border);
    border-radius: 6px;
  }

  .status-item-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.5rem;
  }

  .status-item-title {
    font-weight: 600;
    font-size: 0.875rem;
  }

  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
  }

  .status-badge.ok {
    background: color-mix(in srgb, var(--ui-success) 15%, transparent);
    color: var(--ui-success);
  }

  .status-badge.warning {
    background: color-mix(in srgb, #f59e0b 15%, transparent);
    color: #f59e0b;
  }

  .status-badge.error {
    background: color-mix(in srgb, var(--ui-error) 15%, transparent);
    color: var(--ui-error);
  }

  .status-item-details {
    font-size: 0.75rem;
    color: var(--ui-muted);
    margin-top: 0.5rem;
  }

  .status-actions {
    display: flex;
    gap: 0.75rem;
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--ui-border);
  }

  .status-refresh-btn,
  .status-close-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .status-refresh-btn {
    background: var(--ui-primary);
    color: white;
    border: none;
  }

  .status-refresh-btn:hover {
    background: var(--ui-primary-hover);
  }

  .status-refresh-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .status-close-btn {
    background: transparent;
    border: 1px solid var(--ui-border);
    color: var(--ui-text);
  }

  .status-close-btn:hover {
    background: var(--ui-bg-hover);
  }

  .status-timestamp {
    font-size: 0.75rem;
    color: var(--ui-muted);
    margin-top: 1rem;
    text-align: center;
  }
</style>

<script>
  const STATUS_API_URL = 'https://ref-tool-worker.florianvictorcristea.workers.dev/api/status';
  const CHECK_INTERVAL = 60000; // Check every 60 seconds
  
  let statusCheckInterval: number;
  let lastStatusData: any = null;

  interface SystemStatus {
    status: 'healthy' | 'degraded' | 'unhealthy';
    timestamp: string;
    templates: Array<{
      path: string;
      exists: boolean;
      hash?: string;
      size?: number;
      hashValid?: boolean;
      expectedHash?: string;
      error?: string;
    }>;
    font: {
      exists: boolean;
      hash?: string;
      size?: number;
      hashValid?: boolean;
      expectedHash?: string;
      error?: string;
    };
    autotest?: {
      passed: boolean;
      errors?: string[];
      duration?: number;
    };
    issues?: string[];
  }

  async function checkSystemStatus(forceRefresh = false): Promise<void> {
    const statusIcon = document.getElementById('statusIcon');
    const statusText = document.getElementById('statusText');
    
    if (!statusIcon || !statusText) return;

    try {
      const url = forceRefresh ? `${STATUS_API_URL}?refresh=true` : STATUS_API_URL;
      const response = await fetch(url);
      const data: SystemStatus = await response.json();
      
      lastStatusData = data;
      
      // Update indicator
      statusIcon.className = `status-icon ${data.status}`;
      
      const statusMessages = {
        healthy: '✓ Sistem operațional',
        degraded: '⚠ Funcționare parțială',
        unhealthy: '✗ Sistem indisponibil'
      };
      
      statusText.textContent = statusMessages[data.status] || 'Status necunoscut';
      
      // Update details if panel is open
      const panel = document.getElementById('statusDetailsPanel');
      if (panel && !panel.hasAttribute('hidden')) {
        updateStatusDetails(data);
      }
      
    } catch (error) {
      console.error('Failed to check system status:', error);
      if (statusIcon && statusText) {
        statusIcon.className = 'status-icon unhealthy';
        statusText.textContent = '✗ Eroare verificare';
      }
    }
  }

  function updateStatusDetails(data: SystemStatus): void {
    const container = document.getElementById('statusDetailsContent');
    if (!container) return;

    const templatesHtml = data.templates.map(t => `
      <div class="status-item">
        <div class="status-item-header">
          <span class="status-item-title">${t.path.split('/').pop()}</span>
          <span class="status-badge ${t.exists && t.hashValid !== false ? 'ok' : 'error'}">
            ${t.exists && t.hashValid !== false ? '✓ OK' : '✗ Eroare'}
          </span>
        </div>
        ${!t.exists ? '<div class="status-item-details">Fișier lipsă</div>' : ''}
        ${t.exists && t.hashValid === false ? '<div class="status-item-details">Hash invalid - fișier corupt sau modificat</div>' : ''}
        ${t.exists && t.size ? `<div class="status-item-details">Mărime: ${(t.size / 1024).toFixed(2)} KB</div>` : ''}
      </div>
    `).join('');

    const fontHtml = `
      <div class="status-item">
        <div class="status-item-header">
          <span class="status-item-title">Font (Roboto-Medium.ttf)</span>
          <span class="status-badge ${data.font.exists && data.font.hashValid !== false ? 'ok' : 'error'}">
            ${data.font.exists && data.font.hashValid !== false ? '✓ OK' : '✗ Eroare'}
          </span>
        </div>
        ${!data.font.exists ? '<div class="status-item-details">Fișier lipsă</div>' : ''}
        ${data.font.exists && data.font.hashValid === false ? '<div class="status-item-details">Hash invalid - fișier corupt sau modificat</div>' : ''}
        ${data.font.exists && data.font.size ? `<div class="status-item-details">Mărime: ${(data.font.size / 1024).toFixed(2)} KB</div>` : ''}
      </div>
    `;

    const autotestHtml = data.autotest ? `
      <div class="status-item">
        <div class="status-item-header">
          <span class="status-item-title">Test Automat (U9, U11, U13, U15)</span>
          <span class="status-badge ${data.autotest.passed ? 'ok' : 'error'}">
            ${data.autotest.passed ? '✓ Succes' : '✗ Eșuat'}
          </span>
        </div>
        <div class="status-item-details">Durată: ${data.autotest.duration}ms</div>
        ${data.autotest.errors ? `<div class="status-item-details" style="color: var(--ui-error);">${data.autotest.errors.join(', ')}</div>` : ''}
      </div>
    ` : '';

    const issuesHtml = data.issues && data.issues.length > 0 ? `
      <div class="status-item" style="border-color: var(--ui-error);">
        <div class="status-item-header">
          <span class="status-item-title">Probleme detectate</span>
          <span class="status-badge error">${data.issues.length}</span>
        </div>
        <ul style="margin: 0.5rem 0 0 1.25rem; font-size: 0.875rem; color: var(--ui-error);">
          ${data.issues.map(issue => `<li>${issue}</li>`).join('')}
        </ul>
      </div>
    ` : '';

    container.innerHTML = `
      <div class="status-grid">
        <div class="status-item" style="background: color-mix(in srgb, var(--ui-${data.status === 'healthy' ? 'success' : data.status === 'degraded' ? 'accent' : 'error'}) 5%, transparent);">
          <div class="status-item-header">
            <span class="status-item-title">Status General</span>
            <span class="status-badge ${data.status === 'healthy' ? 'ok' : data.status === 'degraded' ? 'warning' : 'error'}">
              ${data.status.toUpperCase()}
            </span>
          </div>
        </div>
        ${issuesHtml}
        ${templatesHtml}
        ${fontHtml}
        ${autotestHtml}
      </div>
      <div class="status-timestamp">Ultima verificare: ${new Date(data.timestamp).toLocaleString('ro-RO')}</div>
    `;
  }

  function setupStatusWidget(): void {
    const toggleBtn = document.getElementById('statusDetailsToggle');
    const panel = document.getElementById('statusDetailsPanel');
    const closeBtn = document.getElementById('statusCloseBtn');
    const refreshBtn = document.getElementById('statusRefreshBtn');

    toggleBtn?.addEventListener('click', () => {
      const isExpanded = toggleBtn.getAttribute('aria-expanded') === 'true';
      
      if (isExpanded) {
        toggleBtn.setAttribute('aria-expanded', 'false');
        panel?.setAttribute('hidden', '');
      } else {
        toggleBtn.setAttribute('aria-expanded', 'true');
        panel?.removeAttribute('hidden');
        if (lastStatusData) {
          updateStatusDetails(lastStatusData);
        } else {
          checkSystemStatus();
        }
      }
    });

    closeBtn?.addEventListener('click', () => {
      toggleBtn?.setAttribute('aria-expanded', 'false');
      panel?.setAttribute('hidden', '');
    });

    refreshBtn?.addEventListener('click', async () => {
      if (refreshBtn instanceof HTMLButtonElement) {
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="animation: spin 1s linear infinite;">
            <path d="M14 8C14 11.3137 11.3137 14 8 14C4.68629 14 2 11.3137 2 8C2 4.68629 4.68629 2 8 2C9.84799 2 11.4892 2.87733 12.5355 4.22183M12.5355 4.22183L14 2M12.5355 4.22183L10 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Se verifică...
        `;
        
        await checkSystemStatus(true);
        
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path d="M14 8C14 11.3137 11.3137 14 8 14C4.68629 14 2 11.3137 2 8C2 4.68629 4.68629 2 8 2C9.84799 2 11.4892 2.87733 12.5355 4.22183M12.5355 4.22183L14 2M12.5355 4.22183L10 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Reîmprospătează
        `;
      }
    });
  }

  // Initialize
  if (typeof window !== 'undefined') {
    document.addEventListener('DOMContentLoaded', () => {
      setupStatusWidget();
      checkSystemStatus();
      
      // Periodic check
      statusCheckInterval = window.setInterval(() => {
        checkSystemStatus();
      }, CHECK_INTERVAL);
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (statusCheckInterval) {
        clearInterval(statusCheckInterval);
      }
    });
  }
</script>
